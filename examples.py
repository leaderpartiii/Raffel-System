"""
ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Backend (Ğ Ğ¾Ğ»ÑŒ 3) Ğ´Ğ»Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼ (Ğ Ğ¾Ğ»ÑŒ 2)
"""

import logging
from wallet.wallet_manager import WalletManager
from database.db_service import UserService, RaffleService
from transaction.raffle_processor import RaffleProcessor
from contracts.contract_manager import RaffleContractManager

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


# ============================================================================
# ĞŸĞ Ğ˜ĞœĞ•Ğ  1: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ° Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
# ============================================================================
def example_generate_wallet():
    """
    ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ /start Ğ² Ğ±Ğ¾Ñ‚Ğµ:
    1. Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾ÑˆĞµĞ»ĞµĞº
    2. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ğ‘Ğ”
    3. ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ°Ğ´Ñ€ĞµÑ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    """
    print("\n=== ĞŸĞ Ğ˜ĞœĞ•Ğ  1: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ° ===\n")
    
    wallet_manager = WalletManager()
    processor = RaffleProcessor()
    
    # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾ÑˆĞµĞ»ĞµĞº
    wallet = wallet_manager.generate_wallet()
    print(f"âœ… ĞšĞ¾ÑˆĞµĞ»ĞµĞº ÑĞ¾Ğ·Ğ´Ğ°Ğ½!")
    print(f"ğŸ“ ĞĞ´Ñ€ĞµÑ: {wallet['address']}")
    print(f"ğŸ”‘ ĞŸÑ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡: {wallet['private_key'][:20]}...")
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ğ‘Ğ”
    user = UserService.create_user(
        tg_id="123456789",
        evm_address=wallet['address'],
        encrypted_key=wallet['encrypted_private_key']
    )
    print(f"ğŸ’¾ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½: {user.tg_id}")
    
    # ğŸ’¬ Ğ§Ğ¢Ğ ĞĞ¢ĞŸĞ ĞĞ’Ğ˜Ğ¢Ğ¬ Ğ‘ĞĞ¢Ğ£
    return {
        'tg_id': '123456789',
        'address': wallet['address'],
        'private_key': wallet['private_key']  # ĞĞ¢ĞŸĞ ĞĞ’Ğ˜Ğ¢Ğ¬ ĞĞ”Ğ˜Ğ Ğ ĞĞ—!
    }


# ============================================================================
# ĞŸĞ Ğ˜ĞœĞ•Ğ  2: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° USDT
# ============================================================================
def example_check_balance():
    """
    ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "ĞœĞ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ" Ğ² Ğ±Ğ¾Ñ‚Ğµ:
    1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ°Ğ´Ñ€ĞµÑ Ğ¸Ğ· Ğ‘Ğ”
    2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºÑ‡ĞµĞ¹Ğ½Ğµ
    3. ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
    """
    print("\n=== ĞŸĞ Ğ˜ĞœĞ•Ğ  2: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° ===\n")
    
    processor = RaffleProcessor()
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    user = UserService.get_user_by_tg_id("123456789")
    if not user:
        print("âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
        return
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    balance_wei = processor.check_user_balance(user.evm_address)
    balance_usdt = balance_wei / 1e18  # USDT Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ¸Ğ¼ĞµĞµÑ‚ 18 decimals
    
    print(f"ğŸ“ ĞĞ´Ñ€ĞµÑ: {user.evm_address}")
    print(f"ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ USDT: {balance_usdt} (wei: {balance_wei})")
    
    if balance_usdt >= 1.0:
        print("âœ… Ğ¥Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚ Ğ´Ğ»Ñ ÑƒÑ‡Ğ°ÑÑ‚Ğ¸Ñ!")
    else:
        print(f"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ (Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 1.0 USDT)")
    
    return {
        'address': user.evm_address,
        'balance_usdt': balance_usdt,
        'balance_wei': balance_wei
    }


# ============================================================================
# ĞŸĞ Ğ˜ĞœĞ•Ğ  3: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ»Ğ¾Ñ‚ĞµÑ€ĞµĞ¸
# ============================================================================
def example_raffle_status():
    """
    ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ»Ğ¾Ñ‚ĞµÑ€ĞµĞ¸" Ğ² Ğ±Ğ¾Ñ‚Ğµ:
    1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ ÑĞ¾ ÑĞ¼Ğ°Ñ€Ñ‚-ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ğ°
    2. ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Ğ¸ Ğ¿Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ¾Ğ¹ Ñ„Ğ¾Ğ½Ğ´
    """
    print("\n=== ĞŸĞ Ğ˜ĞœĞ•Ğ  3: Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ»Ğ¾Ñ‚ĞµÑ€ĞµĞ¸ ===\n")
    
    processor = RaffleProcessor()
    
    status = processor.get_raffle_status()
    
    print(f"ğŸ‘¥ Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²: {status['players_count']}")
    print(f"ğŸ° Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: {status['state']}")
    print(f"ğŸ’µ Ğ’ÑÑ‚ÑƒĞ¿Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ğ·Ğ½Ğ¾Ñ: {status['entrance_fee'] / 1e18} USDT")
    print(f"ğŸ† ĞŸÑ€Ğ¸Ğ·Ğ¾Ğ²Ğ¾Ğ¹ Ñ„Ğ¾Ğ½Ğ´: {status['pool'] / 1e18} USDT")
    
    return status


# ============================================================================
# ĞŸĞ Ğ˜ĞœĞ•Ğ  4: Ğ’Ñ…Ğ¾Ğ´ Ğ² Ğ»Ğ¾Ñ‚ĞµÑ€ĞµÑ
# ============================================================================
def example_enter_raffle():
    """
    ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "Ğ£Ñ‡Ğ°ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ" Ğ² Ğ±Ğ¾Ñ‚Ğµ:
    1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    3. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ enterRaffle()
    4. ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸
    """
    print("\n=== ĞŸĞ Ğ˜ĞœĞ•Ğ  4: Ğ’Ñ…Ğ¾Ğ´ Ğ² Ğ»Ğ¾Ñ‚ĞµÑ€ĞµÑ ===\n")
    
    processor = RaffleProcessor()
    contract = RaffleContractManager()
    
    tg_id = "123456789"
    user = UserService.get_user_by_tg_id(tg_id)
    
    if not user:
        print("âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
        return
    
    # Ğ’Ñ…Ğ¾Ğ´ Ğ² Ğ»Ğ¾Ñ‚ĞµÑ€ĞµÑ
    print(f"ğŸš€ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ {user.evm_address}...")
    result = processor.process_user_entry(
        tg_id=tg_id,
        evm_address=user.evm_address,
        encrypted_key=user.encrypted_private_key
    )
    
    if result['success']:
        print(f"âœ… Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°!")
        print(f"ğŸ“ Ğ¥ĞµÑˆ: {result['tx_hash']}")
        print(f"â³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ...")
        
        # ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾: Ğ¶Ğ´ĞµĞ¼ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
        try:
            receipt = contract.wait_for_transaction(result['tx_hash'], timeout=60)
            print(f"âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¾ Ğ² Ğ±Ğ»Ğ¾ĞºĞµ {receipt['blockNumber']}")
            print(f"â›½ Ğ“Ğ°Ğ· Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¾: {receipt['gasUsed']}")
        except:
            print(f"â±ï¸ ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµÑ‚ÑÑ...")
    else:
        print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: {result['error']}")
    
    return result


# ============================================================================
# ĞŸĞ Ğ˜ĞœĞ•Ğ  5: Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ€Ğ¾Ğ·Ñ‹Ğ³Ñ€Ñ‹ÑˆĞ° (ĞĞ”ĞœĞ˜Ğ)
# ============================================================================
def example_trigger_draw():
    """
    ĞšĞ¾Ğ³Ğ´Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ñ€Ğ¾Ğ·Ñ‹Ğ³Ñ€Ñ‹Ñˆ:
    1. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ performUpkeep() 
    2. Chainlink VRF Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾
    3. Ğ¡Ğ¼Ğ°Ñ€Ñ‚-ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»Ñ
    4. Ğ­Ğ¼Ğ¸Ñ‚Ğ¸Ñ‚ÑÑ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ WinnerPicked
    5. Event Listener ĞµĞ³Ğ¾ Ğ»Ğ¾Ğ²Ğ¸Ñ‚ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ±Ğ¾Ñ‚Ñƒ
    """
    print("\n=== ĞŸĞ Ğ˜ĞœĞ•Ğ  5: Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ€Ğ¾Ğ·Ñ‹Ğ³Ñ€Ñ‹ÑˆĞ° ===\n")
    
    processor = RaffleProcessor()
    
    print("ğŸ² Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ€Ğ¾Ğ·Ñ‹Ğ³Ñ€Ñ‹Ñˆ...")
    result = processor.trigger_raffle_draw()
    
    if result['success']:
        print(f"âœ… Ğ Ğ¾Ğ·Ñ‹Ğ³Ñ€Ñ‹Ñˆ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!")
        print(f"ğŸ“ Ğ¥ĞµÑˆ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸: {result['tx_hash']}")
        print(f"â³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¾Ñ‚ Chainlink VRF...")
        print(f"ğŸ’¡ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· 1-2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑÑ Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»ÑŒ")
    else:
        print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: {result.get('error', 'Unknown error')}")
    
    return result


# ============================================================================
# ĞŸĞ Ğ˜ĞœĞ•Ğ  6: Ğ¡Ğ»ÑƒÑˆĞ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ (Event Listener)
# ============================================================================
async def example_event_listener():
    """
    Event Listener (Ğ Ğ¾Ğ»ÑŒ 4) Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ² Ñ„Ğ¾Ğ½Ğµ:
    1. Ğ¡Ğ»ÑƒÑˆĞ°ĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ WinnerPicked ÑĞ¾ ÑĞ¼Ğ°Ñ€Ñ‚-ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ğ°
    2. ĞšĞ¾Ğ³Ğ´Ğ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚, Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ğ‘Ğ”
    3. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ñƒ
    """
    print("\n=== ĞŸĞ Ğ˜ĞœĞ•Ğ  6: Ğ¡Ğ»ÑƒÑˆĞ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ ===\n")
    
    from transaction.event_listener import EventListener
    import asyncio
    
    listener = EventListener()
    
    print("ğŸ‘‚ Ğ¡Ğ»ÑƒÑˆĞ°ĞµĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ WinnerPicked...")
    print("(Ğ­Ñ‚Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒÑÑ Ğ² Ñ„Ğ¾Ğ½Ğµ Ğ² Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸)")
    
    # Ğ’ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸ ÑÑ‚Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ
    # Ğ¸ ÑĞ»ÑƒÑˆĞ°ĞµÑ‚ Ğ²ĞµÑÑŒ Ğ´ĞµĞ½ÑŒ
    try:
        # ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: ÑĞ»ÑƒÑˆĞ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ´Ğ»Ñ Ğ´ĞµĞ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
        async for notification in listener.listen_for_winner(run_once=True):
            print(f"\nğŸ‰ Ğ¡ĞĞ‘Ğ«Ğ¢Ğ˜Ğ• ĞŸĞĞ›Ğ£Ğ§Ğ•ĞĞ!")
            print(f"Ğ¢Ğ¸Ğ¿: {notification['type']}")
            print(f"ĞŸĞ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»ÑŒ TG ID: {notification['winner_tg_id']}")
            print(f"ĞĞ´Ñ€ĞµÑ: {notification['winner_address']}")
            print(f"ĞŸÑ€Ğ¸Ğ·: {notification['prize_amount'] / 1e18} USDT")
            print(f"Tx: {notification['tx_hash']}")
            
            # Ğ‘Ğ¾Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:
            # "ğŸ‰ ĞŸĞ¾Ğ·Ğ´Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼! Ğ’Ñ‹ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ğ°Ğ»Ğ¸ X USDT!"
    except Exception as e:
        print(f"ĞĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ¸Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")


# ============================================================================
# ĞŸĞ Ğ˜ĞœĞ•Ğ  7: ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» (Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹)
# ============================================================================
async def example_full_cycle():
    """
    ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹:
    
    1. Ğ®Ğ·ĞµÑ€ /start â†’ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾ÑˆĞµĞ»ĞµĞº
    2. Ğ®Ğ·ĞµÑ€ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ USDT Ğ²Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
    3. Ğ®Ğ·ĞµÑ€ Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "Ğ£Ñ‡Ğ°ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ" â†’ entry Ğ² ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚
    4. Event Listener Ğ»Ğ¾Ğ²Ğ¸Ñ‚ RaffleEnter â†’ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ñƒ
    5. ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ€Ğ¾Ğ·Ñ‹Ğ³Ñ€Ñ‹Ñˆ" â†’ performUpkeep()
    6. Chainlink VRF Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ â†’ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»ÑŒ
    7. Event Listener Ğ»Ğ¾Ğ²Ğ¸Ñ‚ WinnerPicked â†’ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ñƒ
    8. ĞŸĞ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ·
    """
    print("\n" + "="*70)
    print("ğŸ° ĞŸĞĞ›ĞĞ«Ğ™ Ğ¦Ğ˜ĞšĞ› Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ«")
    print("="*70)
    
    # Ğ¨Ğ°Ğ³ 1: Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾ÑˆĞµĞ»ĞµĞº
    print("\n[1] Ğ®Ğ·ĞµÑ€ Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ /start")
    wallet_data = example_generate_wallet()
    
    # Ğ¨Ğ°Ğ³ 2: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ»Ğ¾Ñ‚ĞµÑ€ĞµĞ¸
    print("\n[2] Ğ®Ğ·ĞµÑ€ Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ 'Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ»Ğ¾Ñ‚ĞµÑ€ĞµĞ¸'")
    status = example_raffle_status()
    
    # Ğ¨Ğ°Ğ³ 3: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    print("\n[3] Ğ®Ğ·ĞµÑ€ Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ 'ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ'")
    # (Ğ’ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ Ğ·Ğ´ĞµÑÑŒ Ğ±Ñ‹Ğ» Ğ±Ñ‹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ > 0)
    # balance = example_check_balance()
    
    # Ğ¨Ğ°Ğ³ 4: Ğ®Ğ·ĞµÑ€ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² Ğ»Ğ¾Ñ‚ĞµÑ€ĞµÑ
    print("\n[4] Ğ®Ğ·ĞµÑ€ Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ 'Ğ£Ñ‡Ğ°ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ğ»Ğ¾Ñ‚ĞµÑ€ĞµĞµ'")
    # (Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ½ÑƒĞ¶Ğ½Ñ‹ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹)
    # entry = example_enter_raffle()
    
    # Ğ¨Ğ°Ğ³ 5: ĞĞ´Ğ¼Ğ¸Ğ½ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ñ€Ğ¾Ğ·Ñ‹Ğ³Ñ€Ñ‹Ñˆ
    print("\n[5] ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ñ€Ğ¾Ğ·Ñ‹Ğ³Ñ€Ñ‹Ñˆ")
    draw = example_trigger_draw()
    
    # Ğ¨Ğ°Ğ³ 6: Event Listener Ğ»Ğ¾Ğ²Ğ¸Ñ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
    print("\n[6] Event Listener ÑĞ»ÑƒÑˆĞ°ĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ...")
    # await example_event_listener()
    
    print("\n" + "="*70)
    print("âœ… Ğ¦Ğ˜ĞšĞ› Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•Ğ")
    print("="*70)


# ============================================================================
# Ğ˜ĞĞ¢Ğ•Ğ“Ğ ĞĞ¦Ğ˜Ğ¯ Ğ¡ Ğ‘ĞĞ¢ĞĞœ (Ğ Ğ¾Ğ»ÑŒ 2)
# ============================================================================
"""
ENDPOINT'Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Telegram Bot:

POST /api/wallet/generate
â”œâ”€ Ğ’Ñ…Ğ¾Ğ´: {"tg_id": "123456789"}
â””â”€ Ğ’Ñ‹Ñ…Ğ¾Ğ´: {"address": "0x...", "private_key": "0x..."}

GET /api/wallet/balance/<tg_id>
â”œâ”€ Ğ’Ñ…Ğ¾Ğ´: URL Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹
â””â”€ Ğ’Ñ‹Ñ…Ğ¾Ğ´: {"balance": 1000000, "balance_usdt": 1.0}

GET /api/raffle/status
â”œâ”€ Ğ’Ñ…Ğ¾Ğ´: (Ğ½ĞµÑ‚)
â””â”€ Ğ’Ñ‹Ñ…Ğ¾Ğ´: {"players_count": 5, "state": "OPEN", ...}

POST /api/raffle/enter
â”œâ”€ Ğ’Ñ…Ğ¾Ğ´: {"tg_id": "123456789"}
â””â”€ Ğ’Ñ‹Ñ…Ğ¾Ğ´: {"tx_hash": "0x...", "status": "pending"}

GET /api/user/stats/<tg_id>
â”œâ”€ Ğ’Ñ…Ğ¾Ğ´: URL Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹
â””â”€ Ğ’Ñ‹Ñ…Ğ¾Ğ´: {"total_entries": 3, "total_winnings": 1000000, ...}

POST /api/raffle/draw (ĞĞ”ĞœĞ˜Ğ Ğ¢ĞĞ›Ğ¬ĞšĞ)
â”œâ”€ Ğ’Ñ…Ğ¾Ğ´: Authorization header
â””â”€ Ğ’Ñ‹Ñ…Ğ¾Ğ´: {"tx_hash": "0x..."}
"""


if __name__ == "__main__":
    import asyncio
    
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         ğŸ° Raffle Backend - ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Ğ Ğ¾Ğ»ÑŒ 3)              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    # Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ°
    print("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€:")
    print("1. Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°")
    print("2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°")
    print("3. Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ»Ğ¾Ñ‚ĞµÑ€ĞµĞ¸")
    print("4. Ğ’Ñ…Ğ¾Ğ´ Ğ² Ğ»Ğ¾Ñ‚ĞµÑ€ĞµÑ")
    print("5. Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ€Ğ¾Ğ·Ñ‹Ğ³Ñ€Ñ‹ÑˆĞ°")
    print("6. Ğ¡Ğ»ÑƒÑˆĞ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹")
    print("7. ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»")
    print("8. Ğ’ÑĞµ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹")
    
    choice = input("\nĞ’Ñ‹Ğ±Ğ¾Ñ€ (1-8): ").strip()
    
    try:
        if choice == "1":
            example_generate_wallet()
        elif choice == "2":
            example_check_balance()
        elif choice == "3":
            example_raffle_status()
        elif choice == "4":
            example_enter_raffle()
        elif choice == "5":
            example_trigger_draw()
        elif choice == "6":
            asyncio.run(example_event_listener())
        elif choice == "7":
            asyncio.run(example_full_cycle())
        elif choice == "8":
            example_generate_wallet()
            example_raffle_status()
            example_trigger_draw()
            asyncio.run(example_full_cycle())
        else:
            print("âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€")
    except Exception as e:
        print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: {e}")
        logger.exception("Exception occurred")
